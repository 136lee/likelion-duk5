<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Chat (í…ìŠ¤íŠ¸+ì´ë¯¸ì§€)</title>
</head>
<body>
  <div id="chat" style="margin-bottom:10px;"></div>

  <input id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
  <input id="img" type="file" accept="image/*" />
  <button id="sendBtn">ë³´ë‚´ê¸°</button>

  <script>
  async function send(){
    const chat = document.getElementById("chat");
    const msgEl = document.getElementById("msg");
    const imgEl = document.getElementById("img");

    const msg = msgEl.value.trim();
    const file = imgEl.files[0];

    if (!msg && !file) {
      alert("ë©”ì‹œì§€ ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë„£ì–´ì£¼ì„¸ìš”!");
      return;
    }

    // ë³´ë‚¸ ë‚´ìš© í‘œì‹œ
    let me = `ğŸ‘¤: ${msg || "(ì´ë¯¸ì§€ë§Œ ì „ì†¡)"}`;
    if (file) me += ` <small>+ [ì´ë¯¸ì§€ ì²¨ë¶€]</small>`;
    chat.insertAdjacentHTML("beforeend", `<div>${me}</div>`);

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°(ì„ íƒ)
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        chat.insertAdjacentHTML("beforeend",
          `<img src="${reader.result}" style="max-width:220px;border:1px solid #ddd;margin:6px 0;"/>`
        );
      };
      reader.readAsDataURL(file);
    }

    // FormData ì „ì†¡: í—¤ë” ì„¤ì • ê¸ˆì§€(ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ë©€í‹°íŒŒíŠ¸ í—¤ë” ì…‹ì—…)
    const fd = new FormData();
    if (msg) fd.append("message", msg);
    if (file) fd.append("image", file);

    try {
      const res = await fetch("{% url 'explore:chat_api' %}", {
        method: "POST",
        body: fd
      });
      const data = await res.json();
      chat.insertAdjacentHTML(
        "beforeend",
        `<div>ğŸ¤–: ${data.reply ?? ("ì—ëŸ¬: " + (data.error || res.status))}</div>`
      );
    } catch (e) {
      chat.insertAdjacentHTML("beforeend",
        `<div style="color:red">ìš”ì²­ ì‹¤íŒ¨: ${e}</div>`
      );
    } finally {
      msgEl.value = "";
      imgEl.value = "";
    }
  }

  document.getElementById("sendBtn").addEventListener("click", send);
  </script>
</body>
</html>
