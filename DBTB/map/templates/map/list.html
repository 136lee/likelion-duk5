<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>지도 - {% if scope == 'mine' %}내 지도{% else %}전체 지도{% endif %}</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b76f141ae739da5b568454a96523a207"></script>
  <style>
    body{margin:0;font-family:system-ui,Arial,sans-serif}
    header{padding:12px;background:#f5f5f5;display:flex;gap:10px;align-items:center}
    nav a{padding:6px 10px;border:1px solid #ddd;border-radius:8px;text-decoration:none;color:#333}
    nav a.active{background:#222;color:#fff;border-color:#222}
    #map{width:100%;height:70vh;border-top:1px solid #eee}
    #count{padding:8px 12px;color:#666;font-size:14px}
  </style>
</head>
<body>
  <header>
    <strong>{% if scope == 'mine' %}내 지도{% else %}전체 지도{% endif %}</strong>
    <nav>
      <a href="{% url 'map:list' %}" class="{% if scope == 'list' %}active{% endif %}">전체지도</a>
      <a href="{% url 'map:mine' %}" class="{% if scope == 'mine' %}active{% endif %}">내지도</a>
    </nav>
    <div style="margin-left:auto;">
      {% if request.user.is_authenticated %}
        {{ request.user.username }}님 | <a href="{% url 'account:logout' %}">로그아웃</a>
      {% else %}
        <a href="{% url 'account:login' %}?next={{ request.path|urlencode }}">로그인</a>
      {% endif %}
    </div>
    <a href="{% url 'feed:feed_all' %}">피드</a>
    <a href="{% url 'explore:chat_ai' %}">탐험</a>
    <a href="{% url 'account:mypage' %}">마이페이지</a>
    <a href="{#}">프로필</a>
  </header>

  <div id="map"></div>
  <div id="count">표시된 포스트: 0개</div>

  <script>
  // 스코프: 'list'(전체) 또는 'mine'
  const SCOPE = '{{ scope|escapejs }}' || 'list';
  const isAuth = JSON.parse('{{ request.user.is_authenticated|yesno:"true,false"|escapejs }}');
  const centerLat = parseFloat('{{ center.lat|default:"37.668"|escapejs }}');
  const centerLng = parseFloat('{{ center.lng|default:"127.047"|escapejs }}');

  // 1) 지도(도봉구 중심) — 한 번만 생성
  const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(centerLat, centerLng),
    level: 6
  });

  // 2) 마커 관리 — 한 번만 선언
  let markers = [];
  function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }

  // 좌표 안전 파서
  function getPos(p){
    const lat = Number(p.lat ?? p.latitude);
    const lng = Number(p.lng ?? p.longitude);
    if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
    return new kakao.maps.LatLng(lat, lng);
  }

  function renderMarkers(posts){
    clearMarkers();
    const bounds = new kakao.maps.LatLngBounds();
    let added = 0, skipped = 0;

    const detailPattern = "{% url 'post:detail' 12345 %}";
    const detailUrlFor = (id) => detailPattern.replace(/12345\/?$/, id + "/");


    posts.forEach(p=>{
      const pos = getPos(p);
      if (!pos){ skipped++; return; }
      const m = new kakao.maps.Marker({ position: pos });
      m.setMap(map);
      kakao.maps.event.addListener(m, 'click', () => {
      location.href = detailUrlFor(p.id);   // ✅ 마커 클릭 → 상세 페이지로 이동
      });
      markers.push(m);
      bounds.extend(pos);
      added++;
    });

    if (added > 0) map.setBounds(bounds, 40, 40, 40, 40);
    const $count = document.getElementById('count');
    if ($count) $count.textContent = `표시된 포스트: ${added}개${skipped ? ' (좌표 없음 제외: '+skipped+'개)' : ''}`;
    console.log(`받은 글:${posts.length} / 마커 생성:${added} / 스킵:${skipped}`);
  }

  // 3) 데이터 로드 — 기본: /map/api/posts/  → 404면 /api/posts/로 재시도
  async function fetchPosts(scope){
    const urls = [`/map/api/posts/?scope=${scope}`, `/api/posts/?scope=${scope}`];
    for (const u of urls){
      try{
        const res = await fetch(u);
        console.log('GET', u, res.status);
        if (res.status === 401) { alert('로그인이 필요합니다.'); return []; }
        if (res.ok) return await res.json();
        if (res.status !== 404) { console.error('API 오류', u, await res.text()); return []; }
      }catch(e){ console.error('요청 실패', u, e); }
    }
    console.error('posts API 경로를 찾지 못했습니다. map/urls.py 확인!');
    return [];
  }

  async function load(scope){
    const posts = await fetchPosts(scope);
    renderMarkers(posts);
  }

  // 4) 지도 클릭 → 작성 페이지로 이동
  kakao.maps.event.addListener(map, 'click', (e)=>{
    const lat = e.latLng.getLat().toFixed(6);
    const lng = e.latLng.getLng().toFixed(6);
    const back = location.pathname; // /map/ 또는 /map/mine/
    const createUrl = `{% url 'post:create' %}?lat=${lat}&lng=${lng}&next=${encodeURIComponent(back)}`;
    if (isAuth) location.href = createUrl;
    else location.href = `{% url 'account:login' %}?next=${encodeURIComponent(createUrl)}`;
  });

  // 5) 첫 로드 + 저장 직후 하이라이트
  (async function init(){
    await load(SCOPE); // ← 들어오자마자 전체 마커 로드
    const params = new URLSearchParams(location.search);
    const hLat = parseFloat(params.get('lat'));
    const hLng = parseFloat(params.get('lng'));
    if (!Number.isNaN(hLat) && !Number.isNaN(hLng)) {
      const pos = new kakao.maps.LatLng(hLat, hLng);
      map.setCenter(pos);
      const m = new kakao.maps.Marker({ position: pos, map });
      const iw = new kakao.maps.InfoWindow({ content: '<div style="padding:6px 10px;font-size:13px;">저장 완료!</div>' });
      iw.open(map, m);
      setTimeout(()=> iw.close(), 1800);
      history.replaceState(null, "", location.pathname);
    }
  })();
</script>


</body>
</html>
