<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Kakao Map</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b76f141ae739da5b568454a96523a207"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    header { padding: 1rem; background: #f0f0f0; text-align: center; font-size: 1.2rem; font-weight: bold; }
    #map { width: 100%; height: 500px; border-top: 2px solid #ccc; }

    /* 모달 */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index: 9999;}
    .modal .body {
      max-width: 480px; margin: 8vh auto; background:#fff; padding:16px; border-radius:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
    }
    .modal h3 { margin: 0 0 12px; }
    .row { margin: 8px 0; }
    .row input[type="text"], .row textarea { width:100%; padding:8px; box-sizing:border-box; }
    .actions { display:flex; gap:8px; justify-content:flex-end; margin-top: 12px; }
    button { cursor:pointer; padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#fafafa; }
    button[type="submit"] { background:#222; color:#fff; border-color:#222; }
    
  </style>
</head>
<body>
  <header>지도 페이지</header>

  {% if request.user.is_authenticated %}
    {{request.user.username}}님 환영합니다. <br/>
    <a href="{% url 'account:logout' %}">로그아웃</a>
    <a href="{#}">마이페이지</a>
    {% else %}
    <a href="{% url 'account:login' %}">로그인</a>
    <a href="{% url 'account:signup' %}">회원가입</a>
    {% endif %} 
    <br/>

  <div id="map"></div>

  <!-- ✅ 모달 폼: 전통 폼 제출 방식 (A안) -->
  <div id="postModal" class="modal" aria-hidden="true">
    <div class="body">
      <h3>새 포스트</h3>
      <form method="POST" action="{% url 'post:create' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row">
          <input type="text" name="title" placeholder="제목" required />
        </div>
        <div class="row">
          <textarea name="content" placeholder="내용" rows="4"></textarea>
        </div>
        <div class="row">
          <label>이미지: <input type="file" name="image" accept="image/*" /></label>
        </div>
        <div class="row">
          <label>영상: <input type="file" name="video" accept="video/*" /></label>
        </div>

        <!-- (선택) 카테고리: map:list 뷰에서 categories 내려줄 때만 표시 -->
        {% if categories %}
          <div class="row">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              {% for c in categories %}
                <label style="display:inline-flex; gap:6px; align-items:center;">
                  <input type="checkbox" name="category" value="{{ c.id }}"> {{ c.name }}
                </label>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <!-- 지도 클릭 좌표 주입 -->
        <input type="hidden" name="latitude" id="form-lat" />
        <input type="hidden" name="longitude" id="form-lng" />

        <div class="actions">
          <button type="button" id="closeModalBtn">닫기</button>
          <button type="submit">저장</button>
        </div>
      </form>
    </div>
  </div>


  <!-- 서버에서 넘어온 포스트들 -->
<script id="posts-data" type="application/json">{{ posts_json|default:"[]"|safe }}</script>

<script>
  // Kakao SDK 로드 확인 (가끔 로딩 이슈 방지)
  if (!window.kakao || !kakao.maps) {
    console.error('카카오 지도 스크립트가 로드되지 않았습니다.');
  }

  // 1) 지도 초기화 (한 번만!)
  const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(37.668, 127.047),
    level: 6
  });

  // 2) 모달 엘리먼트
  const modal    = document.getElementById('postModal');
  const closeBtn = document.getElementById('closeModalBtn');
  const latInput = document.getElementById('form-lat');
  const lngInput = document.getElementById('form-lng');

  function openModal()  { modal.style.display = 'block'; modal.setAttribute('aria-hidden','false'); }
  function closeModal() { modal.style.display = 'none';  modal.setAttribute('aria-hidden','true'); }
  closeBtn.addEventListener('click', closeModal);

  // 로그인 여부에 따라 모달 오픈 제어(옵션)
  const isAuth =  JSON.parse('{{ request.user.is_authenticated|yesno:"true,false"|lower }}');
  kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
    if (!isAuth) {
      // 비로그인 시 로그인 페이지로 유도하려면 주석 해제
      location.href = "{% url 'account:login' %}?next={% url 'map:mine' %}";
      return;
    }
    const ll = mouseEvent.latLng;
    latInput.value = ll.getLat();
    lngInput.value = ll.getLng();
    openModal();
  });

  // 3) 항상 DB의 포스트들 마커로 그리기
  const POSTS = JSON.parse(document.getElementById('posts-data').textContent || "[]");
  const markers = [];
  POSTS.forEach(p => {
    const pos = new kakao.maps.LatLng(p.lat, p.lng);
    const m = new kakao.maps.Marker({ position: pos });
    m.setMap(map);
    const iw = new kakao.maps.InfoWindow({ content: `<div style="padding:6px 10px">${p.title}</div>` });
    kakao.maps.event.addListener(m, 'click', () => iw.open(map, m));
    markers.push(m);
  });

  // 4) 저장 직후 하이라이트(쿼리로 lat/lng 넘어온 경우)
  const params  = new URLSearchParams(location.search);
  const sLat    = parseFloat(params.get('lat'));
  const sLng    = parseFloat(params.get('lng'));
  if (!isNaN(sLat) && !isNaN(sLng)) {
    const pos = new kakao.maps.LatLng(sLat, sLng);
    map.setCenter(pos);
    const m = new kakao.maps.Marker({ position: pos });
    m.setMap(map);
    const iw = new kakao.maps.InfoWindow({ content: `<div style="padding:6px 10px; font-size:13px;">저장 완료!</div>` });
    iw.open(map, m);
    setTimeout(() => iw.close(), 2000);
    history.replaceState(null, "", location.pathname); // 새로고침 시 중복 방지
  }
</script>


</body>
</html>
