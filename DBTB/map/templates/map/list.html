{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì§€ë„ - {% if scope == 'mine' %}ë‚´ ì§€ë„{% else %}ì „ì²´ ì§€ë„{% endif %}</title>
  <link rel="stylesheet" href="{% static 'css/account/main.css'%}">
  <script defer src="{% static 'js/account/main.js'%}">

  </script>
  
  

  <!-- Kakao SDK: ë°˜ë“œì‹œ libraries=services í¬í•¨ + ë„ë©”ì¸ ë“±ë¡ -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b76f141ae739da5b568454a96523a207&libraries=services"></script>


</head>

<body> 
  <div id="map"></div>

    <div id="left_bar"> 
      <div id="img">
        <div class="image_sort">
          <a href="{% url 'map:list' %}">
          <img id="DBTB_button_img" src="{% static 'img/DBTB_main_logo.png'%}" >
          </a>
        </div>
        <a class="image_sort" id="move_to_feed"  href="{% url 'feed:feed_all' %}">
          <img id="feed_button_img" src="{% static 'img/feed.png'%}">
          <span>í”¼ë“œ</span>
        </a>
        <a class="image_sort" id="goto_ex" href="{% url 'explore:chat_ai' %}">
          <img id="ex_button_img" src="{% static 'img/explore.png'%}">
          <span>íƒí—˜</span>
        </a>
        
        <br>
         
        <hr id="line1">
        <a  href="{% url 'account:mypage' %}" class="image_sort">
          <div id="move_to_myact">
          <img id="my_act_button_img" src="{% static 'img/my_act.png'%}">
          <div>ë§ˆì´í˜ì´ì§€</div>
        </div>
        </a>
        
      </div>
      <div id="mypage_circle_hole">
        {% if request.user.profile_image %}
            <img id="mypage_img" width="200px" src="{{ request.user.profile_image.url }}" alt="Profile Image">
        {% else %}
            <img id="mypage_img" width="200px" src="{% static 'img/profile_image.jpg' %}" alt="Default Profile">
        {% endif %}
    </div>

    
    
    </div><!--ì™¼ìª½ ë°”-->
  
    <div class="mapVer_and_log">
      <div class="map_version">
        <a href="{% url 'map:list' %}" class="{% if scope == 'list' %}active{% endif %}">ì „ì²´ì§€ë„</a>
        <a href="{% url 'map:mine' %}" class="{% if scope == 'mine' %}active{% endif %}">ë‚´ì§€ë„</a>
      </div>
      <div class="login_or_logout">
    {% if request.user.is_authenticated %}
    {{ request.user.nickname }}ë‹˜ | <a href="{% url 'account:logout' %}">ë¡œê·¸ì•„ì›ƒ</a>
  {% else %}
    <a href="{% url 'account:login' %}?next={{ request.path|urlencode }}">ë¡œê·¸ì¸</a>
  {% endif %}
      </div>

   </div>

    <header id="header_main">
      <div id="search_box">
      <div id="search_div" class="search_border">
        <input id="search" type="search" placeholder="ì§€ë„ ê²€ìƒ‰">
        <img id="search_img" src="{% static 'img/search.png'%}" alt="ë‹ë³´ê¸°">
      </div>
      <!--ê²€ìƒ‰ ê²°ê³¼ ì°½-->
      <div id="menu_wrap" class="menu">
        <ul id="placesList"></ul>
      </div>
    </div>
   
    <div  id="recommend">
      <div id="formal_layer">
        <div id="formal_mentions">
         
        
        <div class="first_mention"><span class="user_name">  {% if request.user.is_authenticated %}{{ request.user.nickname }} {% else %} ê²ŒìŠ¤íŠ¸   {% endif %}
        </span> ë‹˜ì—ê²Œ ì¶”ì²œí•˜ëŠ” ë„ë´‰êµ¬ ìŠ¤íŒŸ!</div>



        <div id="my_location_button"> 
          <span>ë‚´ ìœ„ì¹˜</span>
          <img id="my_location_img" src="{% static 'img/my_location.png'%}" alt="ë‚´ìœ„ì¹˜" >
        </div>
      </div>
        <div class="second_mention">í˜„ì¬ ë‚ ì”¨ì™€ ì‹œê°„ëŒ€ì— ë§ì¶˜ AI ì¶”ì²œ ìŠ¤íŒŸ</div>
     
  
      </div>
      <div class="recommend_spots">
      <div class="recommend_spot">
        <img src="{% static 'img/í’ê²½ì‚¬ì§„1.jpeg'%}">
        <div class="nomal_mention">
        <span>í˜„ìœ„ì¹˜ë¡œ ë¶€í„° <b>300m</b>ì— ìœ„ì¹˜</span>
        <span>ë§‘ì€ í•˜ëŠ˜ì„ ë³¼ ìˆ˜ ìˆëŠ” í˜„ì¬ ë‚ ì”¨ì™€ ë…¸ì„ì„ ë³¼ ìˆ˜ ìˆëŠ” ì§€ê¸ˆ <span class="under_line_mention">ë„ë´‰êµ¬ ìŒë¬¸ë™ ...</span> ìœ¼ë¡œ ê°€ë³´ì„¸ìš”!</span>
        <span class="gray">by <span class="writer_name">í¥ë¶€</span> </span>
        </div>
      </div>
      <div class="recommend_spot">
        <img src="{% static 'img/í’ê²½ì‚¬ì§„2.jpeg'%}">
        <div class="nomal_mention">
        <span>í˜„ìœ„ì¹˜ë¡œ ë¶€í„° <b>500m</b>ì— ìœ„ì¹˜</span>
        <span>ë§‘ì€ í•˜ëŠ˜ì„ ë³¼ ìˆ˜ ìˆëŠ” í˜„ì¬ ë‚ ì”¨ì™€ ë…¸ì„ì„ ë³¼ ìˆ˜ ìˆëŠ” ì§€ê¸ˆ <span class="under_line_mention">ë„ë´‰êµ¬ ë°©í•™ë™ ...</span> ìœ¼ë¡œ ê°€ë³´ì„¸ìš”!</span>
        <span class="gray">by <span class="writer_name">í¥ë¶€</span> </span>
        </div>
      </div>
      </div>
      
    </div>

      </div>
    </header> <!--ì§€ë„ ê²€ìƒ‰-->



               
          
  


 


<!--
  <div id="addrbar">ì£¼ì†Œ: -</div>
-->
<script>
  // ====== í…œí”Œë¦¿ ë³€ìˆ˜ ======
  const SCOPE     = '{{ scope|escapejs }}' || 'list';
  const isAuth    = JSON.parse('{{ request.user.is_authenticated|yesno:"true,false"|escapejs }}');
  const centerLat = parseFloat('{{ center.lat|default:"37.668"|escapejs }}');
  const centerLng = parseFloat('{{ center.lng|default:"127.047"|escapejs }}');

  // ====== ì§€ë„ ìƒì„± (ë„ë´‰êµ¬ ì¤‘ì‹¬) ======
  const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(centerLat, centerLng),
    level: 6
  });

  // ====== ë§ˆì»¤ ê´€ë¦¬ ======
  let markers = [];
  function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }

  // ì¢Œí‘œ ì•ˆì „ íŒŒì„œ
  function getPos(p){
    const lat = Number(p.lat ?? p.latitude);
    const lng = Number(p.lng ?? p.longitude);
    if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
    return new kakao.maps.LatLng(lat, lng);
  }

  // ====== ì—­ì§€ì˜¤ì½”ë”© ìœ í‹¸ ======
  const geocoder   = new kakao.maps.services.Geocoder();
  const infowindow = new kakao.maps.InfoWindow({ zIndex: 2 });
  const addrCache  = new Map(); // "lat,lng" -> address (ê°„ë‹¨ ìºì‹œ)

  function keyOf(lat, lng){ return `${lat.toFixed(6)},${lng.toFixed(6)}`; }

  // ë™ ì •ë³´ ì–»ê¸° (ë²•ì •ë™/í–‰ì •ë™)
function getRegion(lat, lng){
  return new Promise((resolve, reject)=>{
    geocoder.coord2RegionCode(lng, lat, (result, status)=>{
      if (status !== kakao.maps.services.Status.OK) return reject(status);
      const B = result.find(r => r.region_type === 'B'); // ë²•ì •ë™
      const H = result.find(r => r.region_type === 'H'); // í–‰ì •ë™
      resolve({
        dong: (B?.region_3depth_name || H?.region_3depth_name || ''), // ìš°ë¦¬ê°€ ì“¸ ë™
      });
    });
  });
}


  function pickAddress(result){
  const road  = result?.[0]?.road_address?.address_name || '';
  const jibun = result?.[0]?.address?.address_name || '';
  return jibun || road || 'ì£¼ì†Œ ì—†ìŒ';   // ì§€ë²ˆ ë¨¼ì €!
}


  function reverseGeocode(lat, lng){
    const k = keyOf(lat, lng);
    if (addrCache.has(k)) return Promise.resolve(addrCache.get(k));
    return new Promise((resolve, reject)=>{
      geocoder.coord2Address(lng, lat, (result, status)=>{
        if (status !== kakao.maps.services.Status.OK) return reject(status);
        const addr = pickAddress(result);
        addrCache.set(k, addr);
        resolve(addr);
      });
    });
  }

  function setAddrBar(text){
    const el = document.getElementById('addrbar');
    if (el) el.textContent = `ì£¼ì†Œ: ${text}`;
  }

// ====== ë§ˆì»¤ ë Œë”ë§ ======
// ====== ë§ˆì»¤ ë Œë”ë§ ======
function renderMarkers(posts){
    clearMarkers();
    const bounds = new kakao.maps.LatLngBounds();
    let added = 0, skipped = 0;

    const detailPattern = "{% url 'post:post_detail' post_id=12345 %}";
    const detailUrlFor = (id) => detailPattern.replace(/12345\/?$/, String(id) + "/");

    posts.forEach(p=>{
        const pos = getPos(p);
        if (!pos){ skipped++; return; }
        if (!p.id){ skipped++; return; }

        const imageUrl = p.image_url || "{% static 'img/default_marker.png' %}";

        // CustomOverlay content ìƒì„±
        const markerContent = document.createElement('div');
        markerContent.style.position = 'relative';
        markerContent.style.width = '48px';
        markerContent.style.height = '48px';
        markerContent.style.cursor = 'pointer';
        markerContent.style.userSelect = 'none'; // ë“œë˜ê·¸ ë°©ì§€
        markerContent.draggable = false;

        // ë‚´ë¶€ HTML ì‚½ì…
        markerContent.innerHTML = `
            <div style="
                width:48px;
                height:48px;
                background-color: rgba(156,155,80,0.5);
                border-radius:8px;
                display:flex;
                align-items:center;
                justify-content:center;
                overflow:hidden;
                box-shadow:0 2px 6px rgba(0,0,0,0.3);
                padding:5px;
                user-select: none;
            ">
                <img src="${imageUrl}" style="width:100%;height:100%;object-fit:cover;user-select: none;" />
            </div>
            <div style="
                position:absolute;
                left:60%;
                transform:translateX(-50%);
                width:0;
                height:0;
                border-left:8px solid transparent;
                border-right:8px solid transparent;
                border-top:8px solid rgba(156,155,80,0.3);
                user-select: none;
            "></div>
        `;


markerContent.addEventListener('mousedown', (e) => {
    e.stopPropagation(); 
});
        // í´ë¦­ ì´ë²¤íŠ¸: ìƒì„¸í˜ì´ì§€ ì´ë™
        markerContent.addEventListener('click', ()=>{
            location.href = detailUrlFor(p.id);
        });

        // hover â†’ ì£¼ì†Œ í‘œì‹œ
        const overlay = new kakao.maps.CustomOverlay({
            position: pos,
            content: markerContent,
            yAnchor: 1
        });
        overlay.setMap(map);

        markerContent.addEventListener('mouseover', async ()=>{
            const lat = Number(p.lat ?? p.latitude);
            const lng = Number(p.lng ?? p.longitude);
            if (Number.isNaN(lat) || Number.isNaN(lng)) return;
            try {
                const addr = await reverseGeocode(lat, lng);
                infowindow.setContent('<div style="padding:8px 12px;white-space:nowrap;">'+ addr +'</div>');
                infowindow.open(map, overlay);
                setAddrBar(addr);
            } catch(_) {}
        });

        markerContent.addEventListener('mouseout', ()=>{
            infowindow.close();
        });

        markers.push(overlay);
        bounds.extend(pos);
        added++;
    });

    if (added > 0) map.setBounds(bounds, 40, 40, 40, 40);

    const $count = document.getElementById('count');
    if ($count) $count.textContent = `í‘œì‹œëœ í¬ìŠ¤íŠ¸: ${added}ê°œ${skipped ? ' (ì¢Œí‘œ ì—†ìŒ ì œì™¸: '+skipped+'ê°œ)' : ''}`;
    console.log(`ë°›ì€ ê¸€:${posts.length} / ë§ˆì»¤ ìƒì„±:${added} / ìŠ¤í‚µ:${skipped}`);
}



  // ====== í¬ìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ ======
  async function fetchPosts(scope){
    const urls = [`/map/api/posts/?scope=${scope}`, `/api/posts/?scope=${scope}`];
    for (const u of urls){
      try{
        const res = await fetch(u);
        console.log('GET', u, res.status);
        if (res.status === 401) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return []; }
        if (res.ok) return await res.json();
        if (res.status !== 404) {
          console.error('API ì˜¤ë¥˜', u, await res.text());
          return [];
        }
      }catch(e){ console.error('ìš”ì²­ ì‹¤íŒ¨', u, e); }
    }
    console.error('posts API ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. map/urls.py í™•ì¸!');
    return [];
  }

  async function load(scope){
    const posts = await fetchPosts(scope);
    renderMarkers(posts);
  }

  // ====== ì§€ë„ ì¢Œí´ë¦­: addr + dong í•¨ê»˜ ì „ë‹¬ ======
kakao.maps.event.addListener(map, 'click', async (e)=>{
  const lat  = Number(e.latLng.getLat().toFixed(6));
  const lng  = Number(e.latLng.getLng().toFixed(6));
  const back = location.pathname; // /map/ ë˜ëŠ” /map/mine/

  try {
    // ì£¼ì†Œ ë¬¸ìì—´ + ë™ ì´ë¦„ì„ ë™ì‹œì— ì¡°íšŒ
    const [addr, region] = await Promise.all([
      reverseGeocode(lat, lng), // ì´ë¯¸ ìˆëŠ” í•¨ìˆ˜
      getRegion(lat, lng),      // ìœ„ì— ì¶”ê°€í•œ í•¨ìˆ˜
    ]);

    // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì•ˆì „í•˜ê²Œ êµ¬ì„±
    const params = new URLSearchParams({
      lat, lng,
      addr,
      next: back,
      dong: region.dong || '',  // ë™ ì´ë¦„ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
    });

    const createUrl = `{% url 'post:create' %}?${params.toString()}`;
    if (isAuth) location.href = createUrl;
    else location.href = `{% url 'account:login' %}?next=${encodeURIComponent(createUrl)}`;
  } catch (err) {
    // ì‹¤íŒ¨ ì‹œ ì£¼ì†Œë§Œ ì—†ì´ ì¢Œí‘œë§Œ ì „ë‹¬ (í´ë°±)
    const createUrl = `{% url 'post:create' %}?lat=${lat}&lng=${lng}&next=${encodeURIComponent(back)}`;
    if (isAuth) location.href = createUrl;
    else location.href = `{% url 'account:login' %}?next=${encodeURIComponent(createUrl)}`;
  }
});


  // ====== ì§€ë„ ìš°í´ë¦­: ê·¸ ìœ„ì¹˜ ì£¼ì†Œë§Œ ë³´ì—¬ì£¼ê¸° ======
  kakao.maps.event.addListener(map, 'rightclick', async (e)=>{
    const lat = e.latLng.getLat();
    const lng = e.latLng.getLng();
    try {
      const addr = await reverseGeocode(lat, lng);
      setAddrBar(addr);
      infowindow.setContent('<div style="padding:8px 12px;white-space:nowrap;">'+ addr +'</div>');
      infowindow.setPosition(e.latLng);
      infowindow.open(map);
    } catch(_) {}
  });

  // ====== ì´ˆê¸° ë¡œë“œ & ì €ì¥ ì§í›„ í•˜ì´ë¼ì´íŠ¸ ======
  (async function init(){
    await load(SCOPE);

    // ì €ì¥ ì™„ë£Œ í›„ ëŒì•„ì˜¬ ë•Œ ?lat=&lng= ì¿¼ë¦¬ë¡œ í•˜ì´ë¼ì´íŠ¸
    const params = new URLSearchParams(location.search);
    const hLat = parseFloat(params.get('lat'));
    const hLng = parseFloat(params.get('lng'));
    if (!Number.isNaN(hLat) && !Number.isNaN(hLng)) {
      const pos = new kakao.maps.LatLng(hLat, hLng);
      map.setCenter(pos);
      const m = new kakao.maps.Marker({ position: pos, map });
      const iw = new kakao.maps.InfoWindow({ content: '<div style="padding:6px 10px;font-size:13px;">ì €ì¥ ì™„ë£Œ!</div>' });
      iw.open(map, m);
      setTimeout(()=> iw.close(), 1800);
      history.replaceState(null, "", location.pathname);
    }
  })();
// ====== ì¥ì†Œ ê²€ìƒ‰ ======
const ps = new kakao.maps.services.Places();   
    const searchInfowindow = new kakao.maps.InfoWindow({zIndex:1});
    const searchInput = document.getElementById('search');
    const menuWrap = document.getElementById("menu_wrap");
    const searchDiv = document.getElementById("search_div");
    const placesList = document.getElementById('placesList');

    // ê²€ìƒ‰ ì‹¤í–‰ í•¨ìˆ˜
    function searchPlaces() {
      const keyword = searchInput.value.trim();
      if (!keyword) {
        // ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ê¸°ë¡ë§Œ ë³´ì—¬ì£¼ëŠ” ê¸°ëŠ¥ì€ ì•„ë˜ focus ì´ë²¤íŠ¸ë¡œ)
        return;
      }
      
      // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ API í˜¸ì¶œ
      ps.keywordSearch(keyword, placesSearchCB); 
    }

    // ê²€ìƒ‰ ê²°ê³¼ ì½œë°±
    function placesSearchCB(data, status, pagination) {
      if (status === kakao.maps.services.Status.OK) {
        displaySearchResults(data);
      } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
        displayNoResult();
      } else if (status === kakao.maps.services.Status.ERROR) {
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ê²€ìƒ‰ ê²°ê³¼ ì¶œë ¥
    function displaySearchResults(places) {
      placesList.innerHTML = "";
      const bounds = new kakao.maps.LatLngBounds();

      let searchMarkers = [];
      searchMarkers.forEach(m => m.setMap(null));
      searchMarkers = [];

      places.forEach(place => {
        const pos = new kakao.maps.LatLng(place.y, place.x);

        const itemEl = document.createElement('li');
        itemEl.style.display = "flex";
        itemEl.style.alignItems = "center";
        itemEl.style.flexDirection = "row";
        
        const img = document.createElement('img');
        img.src = "{% static 'img/pin.png' %}";
        img.alt = "ê³µí†µì´ë¯¸ì§€";
        img.style.width = "18px";
        img.style.height = "20px";
        img.style.marginRight = "8px";

        const textNode = document.createTextNode(place.place_name);

        itemEl.appendChild(img);
        itemEl.appendChild(textNode);
        placesList.appendChild(itemEl);

        itemEl.onclick = function() {
          searchMarkers.forEach(m => m.setMap(null));
          searchMarkers = [];

          const marker = new kakao.maps.Marker({ position: pos, map: map });
          searchMarkers.push(marker);

          map.setCenter(pos);
          map.setLevel(3);

          let history = JSON.parse(localStorage.getItem("searchHistory")) || [];
          if (!history.includes(place.place_name)) {
            history.unshift(place.place_name);
            history = history.slice(0, 7);
            localStorage.setItem("searchHistory", JSON.stringify(history));
          }
        };

        bounds.extend(pos);
      });

      map.setBounds(bounds);
    }
    
    // ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ ì¶œë ¥
    function displayNoResult() {
        placesList.innerHTML = `
            <li style="padding: 10px; color: #888;">
                <span role="img" aria-label="sad-face">ğŸ˜”</span> ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
            </li>`;
    }

    // ê²€ìƒ‰ì°½ í´ë¦­ ì‹œ ë””ìì¸ ë³€ê²½
    searchDiv.addEventListener("focusin", function() {
      searchDiv.style.boxShadow = "none";
      searchDiv.style.borderRadius = "16px 16px 0 0";
      menuWrap.style.backgroundColor = "white"; 
      menuWrap.style.border = "1px solid rgb(152,159,154)";
      menuWrap.style.display = "flex";
    });

    // í˜ì´ì§€ ì–´ë””ë“  í´ë¦­ ì‹œ ë³µì›
    document.addEventListener("click", function(e) {
      if (
        !searchDiv.contains(e.target) &&
        !menuWrap.contains(e.target) &&
        e.target.id !== "search_img"
      ) {
        searchDiv.style.boxShadow = "0px 5px 10px rgb(152,159,154)";
        searchDiv.style.borderRadius = "16px";
        menuWrap.style.backgroundColor = "transparent";
        menuWrap.style.border = "none";
        menuWrap.style.display = "none";
      }
    });

    // ===== ê²€ìƒ‰ì°½ í´ë¦­ ì‹œ ê¸°ë¡ í‘œì‹œ =====
    function showHistory() {
      placesList.innerHTML = ""; 

      let history = JSON.parse(localStorage.getItem("searchHistory")) || [];
      if (history.length === 0) {
          placesList.innerHTML = `<li style="padding: 10px; color: #888;">ìµœê·¼ ê²€ìƒ‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
          return;
      }

      history.forEach(keyword => {
        const itemEl = document.createElement("li");
        itemEl.style.display = "flex";
        itemEl.style.alignItems = "center";
        itemEl.style.flexDirection = "row";

        const img = document.createElement("img");
        img.src = "{% static 'img/search_pest2.png' %}";
        img.alt = "history";
        img.style.width = "25px";
        img.style.height = "25px";
        img.style.marginRight = "8px";

        const textNode = document.createTextNode(keyword);
        itemEl.appendChild(img);
        itemEl.appendChild(textNode);

        itemEl.onclick = function() {
          searchInput.value = keyword;
          searchPlaces();
        };

        placesList.appendChild(itemEl);
      });
    }

    // ê²€ìƒ‰ì°½ focus ì‹œ ê¸°ë¡ í‘œì‹œ
    searchInput.addEventListener("focus", showHistory);

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ í˜„ì¬ ê²€ìƒ‰ì–´ ê²€ìƒ‰
    document.getElementById('search_img').addEventListener('click', searchPlaces);

    // ì—”í„° í‚¤ ëˆ„ë¥¼ ì‹œ ê²€ìƒ‰
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchPlaces();
      }
    });
  </script>
 

 


</body>
</html>
